{% extends "base.html" %}

{% block title %}Transaksi Penjualan - POSEIDON{% endblock %}

{% block content %}
<style>
.search-nav-instruction {
    display: inline-block;
    background: var(--bs-primary-bg-subtle, #eaf3fb);
    border-radius: 0.5rem;
    padding: 5px 18px 5px 12px;
    color: #19548a;
    font-size: 1em;
    margin-top: 6px;
    margin-bottom: -4px;
    border-left: 4px solid #0d6efd;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(13,110,253,0.04);
    letter-spacing: 0.01em;
    border: 1px solid #b6d4fe;
}

.search-nav-instruction .kbd {
    display: inline-block;
    background: #f8fafd;
    color: #0d6efd;
    border-radius: 0.35rem;
    border: 1px solid #b6d4fe;
    padding: 2px 10px 2px 10px;
    margin: 0 2px;
    font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
    font-size: 1em;
    font-weight: 600;
    box-shadow: none;
    vertical-align: middle;
    letter-spacing: 0.03em;
    transition: background 0.2s, color 0.2s;
    line-height: 1.2;
}

/* Perbaiki warna item aktif pada hasil pencarian agar tidak terlalu terang dan tetap readable */
#searchResults .list-group-item.active, 
#searchResults .list-group-item.active:focus, 
#searchResults .list-group-item.active:hover {
    background-color: #e7f1ff !important; /* biru sangat muda, tidak terlalu terang */
    color: #19548a !important;            /* biru tua, tetap jelas */
    border-color: #b6d4fe !important;
    font-weight: 600;
}

/* Odoo-style quantity input */
.cart-qty-group {
    display: inline-flex;
    align-items: center;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
    background: white;
    max-width: 120px;
}
.cart-qty-btn {
    background: #f8f9fa;
    border: none;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    color: #495057;
    cursor: pointer;
    transition: background-color 0.15s;
}
.cart-qty-btn:hover {
    background: #e9ecef;
}
.cart-qty-btn:active {
    background: #dee2e6;
}
.cart-qty-input {
    border: none;
    outline: none;
    text-align: center;
    width: 56px;
    height: 32px;
    font-size: 14px;
    font-weight: 500;
    background: white;
    -moz-appearance: textfield;
}
.cart-qty-input::-webkit-outer-spin-button,
.cart-qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.cart-qty-group:focus-within {
    border-color: #0d6efd;
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
}

.cart-table, .cart-table > tbody {
    --bs-table-bg: transparent !important;
    background-color: transparent !important;
}
</style>
<div class="row">
    <div class="col-md-12 d-flex justify-content-between align-items-center">
        <h2 class="mb-4">
            <i class="fas fa-cash-register me-2"></i>Transaksi Penjualan
        </h2>
        <div class="view-mode-toggle d-flex align-items-center gap-2 mb-4">
            <span class="text-muted small">Mode Tampilan:</span>
            <div class="btn-group btn-group-sm" role="group" aria-label="View Mode Toggle">
                <input type="radio" class="btn-check" name="viewMode" id="classicMode" value="classic" onchange="switchViewMode('classic')">
                <label class="btn btn-outline-secondary" for="classicMode">
                    <i class="fas fa-th-list me-1"></i>Classic
                </label>
                <input type="radio" class="btn-check" name="viewMode" id="modernMode" value="modern" checked onchange="switchViewMode('modern')">
                <label class="btn btn-outline-primary" for="modernMode">
                    <i class="fas fa-desktop me-1"></i>Modern
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notifikasi</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<!-- Keyboard Shortcuts Info -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            <strong>Keyboard Shortcuts:</strong> 
            <span class="badge bg-primary ms-1">F1</span> Cari Barang
            <span class="badge bg-primary ms-1">F2</span> Proses Pembayaran
            <span class="badge bg-primary ms-1">F3</span> Reset Antrean
            <span class="badge bg-primary ms-1">F4</span> Tambah Antrean
            <span class="badge bg-primary ms-1">F7</span> Antrean Sebelumnya
            <span class="badge bg-primary ms-1">F8</span> Antrean Selanjutnya
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12 d-flex align-items-center">
        <ul class="nav nav-tabs" id="salesQueueTabs" role="tablist" style="flex-grow: 1;">
            {# Tab antrean akan di-generate oleh JavaScript #}
        </ul>
        <button class="btn btn-sm btn-outline-success ms-2" id="addQueueBtn" title="Tambah Antrean (F4)">
            <i class="fas fa-plus"></i> Tambah Antrean
        </button>
    </div>
</div>

<div class="tab-content" id="salesQueueTabContent">
    <div class="row" id="activeSaleContent" style="display: none;"> 
        <div class="col-lg-7 col-md-12 mb-3">
            <div class="card mb-3">
                <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-search me-2"></i>Cari Barang (F1)
                    </h5>
                    <small class="search-nav-instruction alert bg-light border rounded d-inline-block mb-0 fw-semibold ms-auto">
                        <span class="kbd badge bg-light border text-primary fw-semibold">↑</span><span class="kbd badge bg-light border text-primary fw-semibold">↓</span> navigasi,
                        <span class="kbd badge bg-light border text-primary fw-semibold">Enter</span> pilih,
                        <span class="kbd badge bg-light border text-primary fw-semibold">Esc</span> bersihkan
                    </small>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="searchBarang" class="form-control" 
                               placeholder="Ketik nama barang atau scan barcode...">
                        <button class="btn btn-primary" type="button" onclick="searchBarangManual()">
                            <i class="fas fa-search"></i> Cari
                        </button>
                    </div>
                    <div id="searchResults" class="mt-3 list-group"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Keranjang Belanja (<span id="activeQueueName" class="fw-normal">Tidak Ada</span>)</h5>
                </div>
                <div class="card-body">
                    <div id="cartItemsContainer">
                         <div class="text-center text-muted py-4" id="cartEmptyMessage">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <p>Keranjang masih kosong</p>
                        </div>
                    </div>
                    <div id="cartSummary" class="mt-3 pt-3 border-top" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Total Item: <span id="totalItems" class="fw-bold">0</span></h5>
                            </div>
                            <div class="col-md-6 text-end">
                                <h5>Total Harga: <span id="totalHarga" class="fw-bold text-success">Rp 0</span></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5 col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informasi Transaksi</h5>
                </div>
                <div class="card-body">
                    <!-- Ringkasan Harga -->
                    <div id="transaksiPriceSummary" class="mb-3 border rounded p-2 bg-light">
                        <div class="d-flex justify-content-between">
                            <span>Total Item:</span>
                            <span id="transTotalItems" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span>Total Harga:</span>
                            <span id="transTotalHarga" class="fw-bold text-success">Rp 0</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="pelangganSelect" class="form-label">Pelanggan (Opsional)</label>
                        <select id="pelangganSelect" class="form-select">
                            <option value="">-- Pilih Pelanggan --</option>
                            {% for pelanggan_item in pelanggan_list %}
                            <option value="{{ pelanggan_item.id }}">{{ pelanggan_item.nama }} - {{ pelanggan_item.no_hp or 'N/A' }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="metodePembayaran" class="form-label">Metode Pembayaran</label>
                        <select id="metodePembayaran" class="form-select" onchange="toggleCashPaymentFields()">
                            <option value="tunai" selected>Tunai</option>
                            <option value="transfer">Transfer Bank</option>
                            <option value="qris">QRIS</option>
                            <option value="debit">Kartu Debit</option>
                            <option value="kredit">Kartu Kredit</option>
                        </select>
                    </div>
                    <div class="d-grid gap-2 mt-4">
                        <button id="btnBayar" class="btn btn-success btn-lg" onclick="prosesPembayaranCurrentQueue()" disabled>
                            <i class="fas fa-credit-card me-2"></i>Proses Pembayaran (F2)
                        </button>
                        <button class="btn btn-danger" id="btnResetQueue" onclick="resetCurrentQueueConfirm()">
                            <i class="fas fa-redo me-2"></i>Reset Antrean Ini (F3)
                        </button>
                    </div>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-star me-2"></i>Barang Cepat</h6>
                </div>
                <div class="card-body p-0">
                    <div id="quickAddItems">
                        <p class="text-muted p-3"><small>Loading...</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="noQueueMessage" class="col-12 text-center p-5" style="display: none;">
        <i class="fas fa-list-ul fa-3x text-muted mb-3"></i>
        <h4>Tidak ada antrean aktif.</h4>
        <p>Klik "Tambah Antrean" untuk memulai transaksi baru atau pilih antrean yang sudah ada.</p>
    </div>
</div>

<!-- Loading overlay to prevent user interaction during slow network requests -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-light bg-opacity-75 d-none" style="z-index: 2000;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2">Mohon tunggu...</div>
</div>

<div class="modal fade" id="modalKonfirmasi" tabindex="-1" aria-labelledby="modalKonfirmasiLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalKonfirmasiLabel">Konfirmasi Pembayaran</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Antrean:</strong> <span id="konfirmasiAntreanNama" class="fw-bold"></span></p>
                <p><strong>Total Transaksi:</strong> <span id="konfirmasiTotalHarga" class="fw-bold"></span></p>
                <p><strong>Pelanggan:</strong> <span id="konfirmasiPelanggan"></span></p>
                <p><strong>Metode Pembayaran:</strong> <span id="konfirmasiMetodeText"></span></p>
                
                <div id="cashPaymentFields" style="display: none;">
                    <hr>
                    <div class="mb-3">
                        <label for="jumlahBayarInput" class="form-label">Jumlah Bayar (Rp):</label>
                        <input type="text" inputmode="numeric" autocomplete="off" class="form-control" id="jumlahBayarInput" placeholder="Masukkan jumlah uang" oninput="formatRupiahInput(this); calculateChange();">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kembalian (Rp):</label>
                        <input type="text" class="form-control" id="kembalianDisplay" readonly value="Rp 0">
                    </div>
                     <div id="paymentError" class="alert alert-danger mt-2" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-success" id="btnKonfirmasiFinal" onclick="konfirmasiDanBayarCurrentQueue()">
                    <i class="fas fa-check me-2"></i>Ya, Konfirmasi & Bayar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Print Struk -->
<div class="modal fade" id="modalPrintStruk" tabindex="-1" aria-labelledby="modalPrintStrukLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPrintStrukLabel">Pembayaran Berhasil</h5>
        <!-- Remove default close X -->
      </div>
      <div class="modal-body text-center">
        <p class="mb-2"><strong>Jumlah Bayar:</strong><br>
          <span id="printJumlahBayar" class="display-5 fw-bold text-success"></span></p>
        <p class="mb-3"><strong>Kembalian:</strong><br>
          <span id="printKembalian" class="display-5 fw-bold text-primary"></span></p>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" id="btnPrintStruk" type="button" tabindex="0"><i class="fas fa-print me-2"></i>Print Struk</button>
          <button class="btn btn-secondary flex-fill" id="btnClosePrintStruk">Tutup</button>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
#modalPrintStruk .display-5 { font-size: 2.5rem; }
#modalPrintStruk .btn:focus-visible {
  outline: 3px solid #0d6efd;
  outline-offset: 2px;
  box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
  z-index: 2;
}
#modalPrintStruk .btn:focus:not(:focus-visible) {
  outline: none;
  box-shadow: none;
}
</style>

<!-- Area struk yang hanya muncul saat print -->
<style>
@media print {
  body * { visibility: hidden !important; }
  #strukArea, #strukArea * { visibility: visible !important; }
  #strukArea { position: absolute; left: 0; top: 0; width: 100vw; background: #fff; z-index: 99999; }
}
</style>
<div id="strukArea" class="d-none"></div>

{% endblock %}

{% block scripts %}
<script>
let salesQueues = []; 
let activeQueueId = null;

// === VIEW MODE SWITCHING ===
async function switchViewMode(mode) {
    console.log('Switching view mode to:', mode);
    console.log('Current activeQueueId:', activeQueueId);
    console.log('Current salesQueues before switch:', JSON.stringify(salesQueues, null, 2));
    
    // Save current cart to backend first
    if (activeQueueId) {
        console.log('Saving cart to backend before switch...');
        await updateQueueCartToBackend(activeQueueId);
        console.log('Cart saved to backend');
    }
    
    // Save current state before switching
    const currentState = {
        salesQueues: salesQueues,
        activeQueueId: activeQueueId,
        pelangganId: document.getElementById('pelangganSelect')?.value || '',
        metodePembayaran: document.getElementById('metodePembayaran')?.value || 'tunai'
    };
    
    console.log('Modern: Saving state to sessionStorage before switch:', JSON.stringify(currentState, null, 2));
    
    // Ensure cart items have both modern and classic format fields
    currentState.salesQueues.forEach(queue => {
        if (queue.cart && Array.isArray(queue.cart)) {
            queue.cart.forEach(item => {
                // Ensure both quantity fields exist
                if (item.jumlah !== undefined && item.quantity === undefined) {
                    item.quantity = item.jumlah;
                }
                if (item.quantity !== undefined && item.jumlah === undefined) {
                    item.jumlah = item.quantity;
                }
                
                // Ensure both name fields exist
                if (item.nama && !item.name) {
                    item.name = item.nama;
                }
                if (item.name && !item.nama) {
                    item.nama = item.name;
                }
                
                // Ensure both code fields exist
                if (item.kode && !item.code) {
                    item.code = item.kode;
                }
                if (item.code && !item.kode) {
                    item.kode = item.code;
                }
                
                // Ensure both price fields exist
                if (item.harga !== undefined && item.unitPrice === undefined) {
                    item.unitPrice = item.harga;
                }
                if (item.unitPrice !== undefined && item.harga === undefined) {
                    item.harga = item.unitPrice;
                }
                
                // Calculate total if missing - use current quantity and price
                const currentQty = item.jumlah || item.quantity || 0;
                const currentPrice = item.harga || item.unitPrice || 0;
                if (!item.total || item.total === 0) {
                    item.total = currentQty * currentPrice;
                }
                
                // Ensure price type mapping
                if (item.tipe_harga && !item.priceType) {
                    item.priceType = item.tipe_harga === 'grosir' ? 'Grosir' : 'Eceran';
                }
                if (item.priceType && !item.tipe_harga) {
                    item.tipe_harga = item.priceType.toLowerCase();
                }
                
                // Ensure stock fields are preserved during transition
                if (!item.stok_awal && item.originalProduct?.stok) {
                    item.stok_awal = item.originalProduct.stok;
                }
                if (!item.originalProduct && item.stok_awal) {
                    item.originalProduct = {
                        id: item.id,
                        stok: item.stok_awal,
                        harga_jual: item.harga_eceran || item.unitPrice || item.harga,
                        harga_grosir: item.harga_grosir,
                        batas_minimal_grosir: item.batas_minimal_grosir || 10
                    };
                }
                
                console.log('Modern: Prepared item for transition with stock:', item.stok_awal, 'originalProduct.stok:', item.originalProduct?.stok);
                console.log('Modern: Prepared item for transition:', JSON.stringify(item, null, 2));
            });
        }
    });
    
    // Set cookie to remember preference
    document.cookie = `sales_view_mode=${mode}; path=/; max-age=31536000`; // 1 year
    
    // Store state in sessionStorage for seamless transition
    sessionStorage.setItem('salesTransitionState', JSON.stringify(currentState));
    
    // Show loading overlay
    showLoadingOverlay();
    
    // Redirect to sales page (views.py will read cookie and render appropriate template)
    window.location.href = '/sales/penjualan';
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function restoreStateAfterTransition() {
    const savedState = sessionStorage.getItem('salesTransitionState');
    console.log('Restoring state from sessionStorage:', savedState);
    
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            console.log('Parsed state:', state);
            
            // Restore queues and active queue
            if (state.salesQueues && state.salesQueues.length > 0) {
                console.log('Restoring salesQueues from state...');
                // Normalize cart data format and ensure proper arrays
                salesQueues = state.salesQueues.map(queue => ({
                    ...queue,
                    cart: Array.isArray(queue.cart) ? queue.cart.map(item => normalizeCartItemModern(item)) : []
                }));
                activeQueueId = state.activeQueueId;
                
                console.log('Restored salesQueues:', JSON.stringify(salesQueues, null, 2));
                console.log('Restored activeQueueId:', activeQueueId);
                
                // Restore UI selections
                if (state.pelangganId) {
                    const pelangganSelect = document.getElementById('pelangganSelect');
                    if (pelangganSelect) pelangganSelect.value = state.pelangganId;
                }
                
                if (state.metodePembayaran) {
                    const metodeSelect = document.getElementById('metodePembayaran');
                    if (metodeSelect) metodeSelect.value = state.metodePembayaran;
                }
                
                // Re-render UI with restored state
                renderQueueTabs();
                updateCartDisplay();
                toggleCashPaymentFields();
                
                // Focus on search input after state restoration
                setTimeout(() => {
                    const searchInput = document.getElementById('searchBarang');
                    if (searchInput) searchInput.focus();
                }, 100);
                
                console.log('State restoration completed');
            } else {
                console.log('No salesQueues in saved state, loading from backend...');
            }
            
            // Clear the saved state
            sessionStorage.removeItem('salesTransitionState');
        } catch (e) {
            console.error('Error restoring transition state:', e);
        }
    } else {
        console.log('No saved state found in sessionStorage');
    }
}

// Normalize cart item to ensure consistent format for modern template
function normalizeCartItemModern(item) {
    if (!item) return null;
    
    console.log('Modern: Normalizing item:', JSON.stringify(item, null, 2));
    
    // Prioritize the correct quantity value based on source template
    let quantity;
    if (item.quantity !== undefined && item.jumlah !== undefined) {
        console.log('Modern: Both quantity fields exist - quantity:', item.quantity, 'jumlah:', item.jumlah);
        // If both exist, use the one that matches the total calculation
        const qtyFromTotal = item.total && item.unitPrice ? item.total / item.unitPrice : 0;
        const qtyDiffFromQuantity = Math.abs(qtyFromTotal - item.quantity);
        const qtyDiffFromJumlah = Math.abs(qtyFromTotal - item.jumlah);
        quantity = qtyDiffFromQuantity <= qtyDiffFromJumlah ? item.quantity : item.jumlah;
        console.log('Modern: Selected quantity:', quantity, 'based on total calculation');
    } else {
        quantity = parseFloat(item.quantity || item.jumlah || 0);
        console.log('Modern: Using single quantity field:', quantity);
    }
    
    // Get pricing information
    const hargaEceran = parseFloat(item.harga_eceran || item.originalProduct?.harga_jual || item.unitPrice || item.harga || 0);
    const hargaGrosir = item.harga_grosir ? parseFloat(item.harga_grosir) : null;
    const batasMinimalGrosir = item.batas_minimal_grosir || 10;
    
    // Prioritize stock information from multiple sources
    let stockAwal = 0;
    if (item.stok_awal !== undefined && item.stok_awal !== null && item.stok_awal !== 0) {
        stockAwal = parseFloat(item.stok_awal);
    } else if (item.originalProduct?.stok !== undefined && item.originalProduct.stok !== null && item.originalProduct.stok !== 0) {
        stockAwal = parseFloat(item.originalProduct.stok);
    } else if (item.stok !== undefined && item.stok !== null && item.stok !== 0) {
        stockAwal = parseFloat(item.stok);
    } else {
        // Last resort: if all stock fields are 0 or missing, try to preserve any existing value
        stockAwal = parseFloat(item.stok_awal || item.originalProduct?.stok || item.stok || 0);
    }
    
    console.log('Modern: Stock info - final stockAwal:', stockAwal, 'from item.stok_awal:', item.stok_awal, 'originalProduct.stok:', item.originalProduct?.stok, 'item.stok:', item.stok);
    
    // Recalculate price and type based on current quantity
    let currentPrice = hargaEceran;
    let priceType = 'eceran';
    
    if (hargaGrosir && quantity >= batasMinimalGrosir) {
        currentPrice = hargaGrosir;
        priceType = 'grosir';
    }
    
    const normalizedItem = {
        // Modern template format (primary)
        id: item.id,
        nama: item.nama || item.name || item.nama_barang || '',
        kode: item.kode || item.code || item.kode_barang || '',
        harga: currentPrice,
        jumlah: quantity,
        stok_awal: stockAwal,
        satuan: item.satuan || 'Pcs',
        harga_grosir: hargaGrosir,
        batas_minimal_grosir: batasMinimalGrosir,
        tipe_harga: priceType,
        harga_eceran: hargaEceran,
        
        // Classic template format (for compatibility)
        name: item.nama || item.name || item.nama_barang || '',
        code: item.kode || item.code || item.kode_barang || '',
        quantity: quantity,
        unitPrice: currentPrice,
        total: currentPrice * quantity,
        priceType: priceType === 'grosir' ? 'Grosir' : 'Eceran',
        
        // Preserve original product data for stock validation
        originalProduct: item.originalProduct || {
            id: item.id,
            harga_jual: hargaEceran,
            harga_grosir: hargaGrosir,
            batas_minimal_grosir: batasMinimalGrosir,
            stok: stockAwal
        }
    };
    
    console.log('Modern: Normalized item with price type:', normalizedItem.tipe_harga, 'quantity:', normalizedItem.jumlah, 'price:', normalizedItem.harga);
    
    console.log('Modern: Normalized item:', JSON.stringify(normalizedItem, null, 2));
    return normalizedItem;
}

function goToPreviousQueue() {
    if (!salesQueues.length || !activeQueueId) return;
    const idx = salesQueues.findIndex(q => q.id === activeQueueId);
    if (idx === -1) return;
    const prevIdx = (idx - 1 + salesQueues.length) % salesQueues.length;
    const prevQueue = salesQueues[prevIdx];
    if (prevQueue) switchQueue(prevQueue.id);
}

function goToNextQueue() {
    if (!salesQueues.length || !activeQueueId) return;
    const idx = salesQueues.findIndex(q => q.id === activeQueueId);
    if (idx === -1) return;
    const nextIdx = (idx + 1) % salesQueues.length;
    const nextQueue = salesQueues[nextIdx];
    if (nextQueue) switchQueue(nextQueue.id);
}


// === SERVER-SIDE QUEUE ONLY ===

// ESC hotkey to close Pembayaran Berhasil modal
window.addEventListener('keydown', function(e) {
    const modal = document.getElementById('modalPrintStruk');
    const btnClose = document.getElementById('btnClosePrintStruk');
    if (modal && btnClose && modal.classList.contains('show') && (e.key === 'Escape' || e.key === 'Esc')) {
        e.preventDefault();
        btnClose.click();
    }
});
async function syncQueuesFromBackend() {
    const res = await fetch('/sales/antrian');
    const backendQueues = await res.json();
    // Pastikan tidak ada duplikat backendId di salesQueues
    const uniqueQueues = [];
    const seenIds = new Set();
    backendQueues.forEach(q => {
        if (!seenIds.has(q.id)) {
            seenIds.add(q.id);
            uniqueQueues.push({
                id: 'antrian-' + q.id,
                name: q.nama_antrian,
                cart: [], // Always initialize as empty array
                customerId: '',
                paymentMethod: 'tunai',
                backendId: q.id
            });
        }
    });
    salesQueues = uniqueQueues;
    if (salesQueues.length > 0) {
        activeQueueId = salesQueues[0].id;
    } else {
        activeQueueId = null;
    }
    renderQueueTabs();
    updateCartDisplay();
}

async function addQueue() {
    showLoadingOverlay();
    // Cari nomor antrean terbesar yang ada
    let maxNum = 0;
    salesQueues.forEach(q => {
        const match = q.name.match(/Antrean\s*#?(\d+)/i);
        if (match) {
            const num = parseInt(match[1], 10);
            if (num > maxNum) maxNum = num;
        }
    });
    const newQueueName = `Antrean #${maxNum + 1}`;
    try {
        const res = await fetch('/sales/antrian/tambah', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nama_antrian: newQueueName, data_antrian: JSON.stringify([]) })
        });
        if (!res.ok) {
            const errText = await res.text();
            console.error('Gagal tambah antrean:', errText);
            showToast('Gagal', 'Gagal menambah antrean ' + "", 'error');
            return;
        }
        const data = await res.json();
        if (data.success) {
            await syncQueuesFromBackend();
            const newQueue = salesQueues.find(q => q.backendId == data.id);
            if (newQueue) {
                await switchQueue(newQueue.id);
                await updateQueueCartToBackend(newQueue.id);
            }
            renderQueueTabs();
        } else {
            console.error('Tambah antrean gagal:', data.message);
            showToast('Gagal', 'Tambah antrean gagal: ' + (data.message || 'unknown error'), 'error');
        }
    } catch (e) {
        console.error('Error saat menambah antrean:', e);
        showToast('Error', 'Tidak dapat menambah antrean: ' + e.message, 'error');
    } finally {
        hideLoadingOverlay();
    }
}

async function deleteQueue(queueId) {
    showLoadingOverlay();
    try {
    const queue = salesQueues.find(q => q.id === queueId);
    if (queue && queue.backendId) {
        await fetch(`/sales/antrian/${queue.backendId}/hapus`, {method: 'POST', keepalive: true});
        await syncQueuesFromBackend();
        // Setelah sync, set antrean aktif ke antrean pertama jika ada
        if (salesQueues.length > 0) {
            activeQueueId = salesQueues[0].id;
            await switchQueue(activeQueueId);
        } else {
            activeQueueId = null;
            renderQueueTabs();
            updateCartDisplay();
        }
        }
    } catch(err) {
        console.error('Gagal menghapus antrean:', err);
        showToast('Error', 'Gagal menghapus antrean', 'error');
    } finally {
        hideLoadingOverlay();
    }
}

async function switchQueue(queueId) {
    activeQueueId = queueId;
    const queue = salesQueues.find(q => q.id === queueId);
    if (queue && queue.backendId) {
        const res = await fetch(`/sales/antrian/${queue.backendId}/ambil`);
        const data = await res.json();
        if (data.data_antrian) {
            try {
                const parsed = JSON.parse(data.data_antrian);
                if (Array.isArray(parsed)) {
                    // Old format: direct array
                    queue.cart = parsed.map(item => normalizeCartItemModern(item));
                } else if (parsed && typeof parsed === 'object') {
                    // New format: object with cart and paymentMethod
                    queue.cart = Array.isArray(parsed.cart) ? parsed.cart.map(item => normalizeCartItemModern(item)) : [];
                    queue.paymentMethod = parsed.paymentMethod || 'tunai';
                } else {
                    queue.cart = [];
                }
            } catch (e) {
                console.warn('Failed to parse cart data:', e);
                queue.cart = [];
            }
        } else {
            queue.cart = [];
        }
    }
    // Ensure cart is always an array
    if (!queue || !Array.isArray(queue.cart)) {
        if (queue) queue.cart = [];
    }
    renderQueueTabs();
    updateCartDisplay();
}

async function updateQueueCartToBackend(queueId) {
    const queue = salesQueues.find(q => q.id === queueId);
    if (!queue) return;

    console.log('Modern: Saving cart to backend for queue:', queueId);
    console.log('Modern: Cart data being saved:', JSON.stringify(queue.cart, null, 2));

    const persisted = {
        cart: queue.cart || [],
        paymentMethod: queue.paymentMethod || 'tunai'
    };
    const payload = {
        nama_antrian: queue.name,
        data_antrian: JSON.stringify(persisted)
    };

    try {
        if (queue.backendId) {
            // Update queue that already exists in backend
            const response = await fetch(`/sales/antrian/${queue.backendId}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                console.error('Failed to update queue in backend:', response.statusText);
            }
        } else {
            // Fallback: create new queue
            const res = await fetch('/sales/antrian/tambah', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                const data = await res.json();
                // Simpan backendId ke queue agar tidak membuat duplikat di masa depan
                queue.backendId = data.id;
            }
        }
    } catch (err) {
        console.error('Failed to sync queue to backend:', err);
    }
}

let searchTimeout;
let barcodeBuffer = '';
let barcodeEventTimeout; 
const modalKonfirmasiInstance = new bootstrap.Modal(document.getElementById('modalKonfirmasi'));

// Tekan Enter pada jumlahBayarInput untuk konfirmasi pembayaran jika uang cukup
setTimeout(() => {
    const input = document.getElementById('jumlahBayarInput');
    if (input) {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const btn = document.getElementById('btnKonfirmasiFinal');
                if (btn && !btn.disabled) btn.click();
            }
        });
    }
}, 500);

document.getElementById('modalKonfirmasi').addEventListener('shown.bs.modal', function () {
    const input = document.getElementById('jumlahBayarInput');
    if (input) input.focus();
});

function generateQueueId() { return 'queue-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9); }

function deepCopyCart(cart) {
    if (!Array.isArray(cart)) return [];
    return cart.map(item => ({ ...item })); 
}

// === LOADING OVERLAY HELPERS ===
function showLoadingOverlay() {
    const ov = document.getElementById('loadingOverlay');
    if (ov) {
        ov.classList.remove('d-none');
    }
}
function hideLoadingOverlay() {
    const ov = document.getElementById('loadingOverlay');
    if (ov) {
        ov.classList.add('d-none');
    }
}

function renderQueueTabs() {
    const tabsContainer = document.getElementById('salesQueueTabs');
    const activeSaleContentDiv = document.getElementById('activeSaleContent');
    const noQueueMessageDiv = document.getElementById('noQueueMessage');
    tabsContainer.innerHTML = '';
    
    salesQueues.forEach(queue => {
        const isActive = queue.id === activeQueueId;
        // Buat elemen li
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.setAttribute('role', 'presentation');

        // Buat button tab
        const button = document.createElement('button');
        button.className = `nav-link ${isActive ? 'active' : ''}`;
        button.id = `tab-${queue.id}`;
        button.setAttribute('data-bs-toggle', 'tab');
        button.setAttribute('data-queue-id', queue.id);
        button.setAttribute('type', 'button');
        button.setAttribute('role', 'tab');
        button.setAttribute('aria-controls', 'sale-content');
        button.setAttribute('aria-selected', isActive);
        button.textContent = queue.name;

        // Tambahkan close button jika ada lebih dari 1 antrean
        if (salesQueues.length > 1) {
            const closeSpan = document.createElement('span');
            closeSpan.className = 'badge bg-danger ms-1';
            closeSpan.style.cssText = 'cursor:pointer; font-size:0.6em; padding: 0.3em 0.5em;';
            closeSpan.title = 'Hapus Antrean Ini';
            closeSpan.textContent = '×';

            // Event listener khusus untuk close button
            closeSpan.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                deleteQueue(queue.id);
            });

            button.appendChild(closeSpan);
        }

        // Event listener untuk switch tab
        button.addEventListener('click', function(event) {
            // Jangan switch jika yang diklik adalah close button
            if (event.target.classList.contains('badge')) {
                return;
            }
            const queueId = event.currentTarget.getAttribute('data-queue-id');
            if (queueId !== activeQueueId) {
                switchQueue(queueId);
            }
        });

        li.appendChild(button);
        tabsContainer.appendChild(li);
    });

    const currentActiveQueueExists = salesQueues.some(q => q.id === activeQueueId);
    if (activeQueueId && currentActiveQueueExists) {
        activeSaleContentDiv.style.display = 'flex'; 
        noQueueMessageDiv.style.display = 'none';
        const activeQ = salesQueues.find(q => q.id === activeQueueId);
        if(activeQ) document.getElementById('activeQueueName').textContent = activeQ.name;
    } else {
        activeSaleContentDiv.style.display = 'none';
        noQueueMessageDiv.style.display = 'block';
        document.getElementById('activeQueueName').textContent = 'Tidak Ada';
    }
}


function addToCart(id, nama, kode, harga, stok, satuan, hargaGrosir, batasMinimalGrosir) {
    if (!activeQueueId) { alert("Pilih atau buat antrean terlebih dahulu!"); return; }
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ) { alert("Antrean aktif tidak valid!"); return; }

    // Stok is the current available stock from DB for this item, not item.stok_awal from cart
    const itemOriginalStock = parseFloat(stok) || 0; 
    if (itemOriginalStock <= 0) { alert(`Stok ${nama} habis.`); return; }
    
    const existingItem = activeQ.cart.find(item => item.id === id);
    if (existingItem) {
        if (existingItem.jumlah < itemOriginalStock) { 
            existingItem.jumlah++;
            
            // Periksa apakah harus menggunakan harga grosir
            if (hargaGrosir && existingItem.jumlah >= (batasMinimalGrosir || 10)) {
                if (!existingItem.harga_eceran) { existingItem.harga_eceran = existingItem.harga; }
                existingItem.harga = parseFloat(hargaGrosir);
                existingItem.tipe_harga = 'grosir';
            }
        } else { 
            alert(`Stok ${nama} tidak mencukupi (tersisa: ${itemOriginalStock}, di keranjang: ${existingItem.jumlah}).`); return; 
        }
    } else {
        // Item baru, periksa apakah harus langsung menggunakan harga grosir
        const hargaItem = parseFloat(harga) || 0;
        const hargaGrosirValue = hargaGrosir ? parseFloat(hargaGrosir) : null;
        const batasGrosir = batasMinimalGrosir || 10;
        
        let finalHarga = hargaItem;
        let tipeHarga = 'eceran';
        
        // Jika quantity 1 sudah memenuhi batas grosir, langsung set ke grosir
        if (hargaGrosirValue && 1 >= batasGrosir) {
            finalHarga = hargaGrosirValue;
            tipeHarga = 'grosir';
        }
        
        activeQ.cart.push({
            id, 
            nama, 
            kode, 
            harga: finalHarga, 
            harga_eceran: hargaItem,
            jumlah: 1, 
            stok_awal: itemOriginalStock,
            satuan: satuan || 'Pcs',
            harga_grosir: hargaGrosirValue,
            batas_minimal_grosir: batasGrosir,
            tipe_harga: tipeHarga
        });
    }
    document.getElementById('searchBarang').value = ''; 
    document.getElementById('searchResults').innerHTML = ''; 
    updateCartDisplay(); 
    highlightCartRow(id);
    updateQueueCartToBackend(activeQueueId); 
}

function updateCartDisplay() {
    const cartItemsContainer = document.getElementById('cartItemsContainer');
    const cartEmptyMessage = document.getElementById('cartEmptyMessage');
    
    cartItemsContainer.innerHTML = ''; // Clear previous content
    cartItemsContainer.appendChild(cartEmptyMessage); // Re-add empty message template

    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    
    // Recalculate price types for all items to ensure badges show correctly
    if (activeQ && activeQ.cart) {
        activeQ.cart.forEach(item => {
            // Get wholesale price from item or originalProduct
            const hargaGrosir = item.harga_grosir || item.originalProduct?.harga_grosir;
            const batasMinimal = item.batas_minimal_grosir || item.originalProduct?.batas_minimal_grosir || 10;
            
            if (hargaGrosir && item.jumlah >= batasMinimal) {
                if (!item.harga_eceran) { 
                    item.harga_eceran = item.harga; 
                }
                item.harga = parseFloat(hargaGrosir);
                item.tipe_harga = 'grosir';
                // Update the item's harga_grosir if it was null
                if (!item.harga_grosir) {
                    item.harga_grosir = parseFloat(hargaGrosir);
                }
            } else if (item.harga_eceran && item.tipe_harga === 'grosir') {
                item.harga = item.harga_eceran;
                item.tipe_harga = 'eceran';
            }
        });
    }

    if (!activeQ) { 
        cartEmptyMessage.style.display = 'block';
        document.getElementById('cartSummary').style.display = 'none';
        document.getElementById('btnBayar').disabled = true;
        // activeQueueName should be handled by renderQueueTabs
        return;
    }

    const currentDisplayCart = activeQ.cart; 

    if (currentDisplayCart.length === 0) {
        cartEmptyMessage.style.display = 'block';
        document.getElementById('cartSummary').style.display = 'none';
        document.getElementById('btnBayar').disabled = true;
    } else {
        cartEmptyMessage.style.display = 'none';
        const table = document.createElement('table');
        table.className = 'table table-sm cart-table';
        table.style.cssText = '--bs-table-bg: transparent; background-color: transparent;';
        table.innerHTML = `<thead><tr><th>Barang</th><th class="text-center">Jumlah</th><th class="text-end">Subtotal</th><th class="text-center">Aksi</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        currentDisplayCart.forEach(item => {
            const itemHarga = parseFloat(item.harga) || 0;
            const itemJumlah = parseFloat(item.jumlah) || 0;
            const itemStokAwal = parseFloat(item.stok_awal) || 0;
            const itemSatuan = item.satuan || 'Pcs';
            const itemTipeHarga = item.tipe_harga || 'eceran';

            row = tbody.insertRow();
            row.setAttribute('data-item-id', item.id);
            row.innerHTML = `
                <td>
                    ${item.nama}<br>
                    <small class="text-muted">Rp ${itemHarga.toLocaleString()}</small>
                    ${itemTipeHarga === 'grosir' ? '<span class="badge bg-info text-dark ms-1">Grosir</span>' : ''}
                </td>
                <td class="text-center align-middle">
                    <div class="cart-qty-group">
                        <button class="cart-qty-btn" type="button" onclick="decrementQuantity(${item.id})">−</button>
                        <input type="number" step="any" class="cart-qty-input" value="${itemJumlah}" 
                               onchange="updateQuantity(${item.id}, this.value)" min="1" max="${itemStokAwal}">
                        <button class="cart-qty-btn" type="button" onclick="incrementQuantity(${item.id})">+</button>
                    </div>
                    <small class="text-muted d-block mt-1">${itemSatuan}</small>
                </td>
                <td class="text-end align-middle">Rp ${(itemHarga * itemJumlah).toLocaleString()}</td>
                <td class="text-center align-middle"><button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.id})"><i class="fas fa-trash"></i></button></td>`;
        });
        cartItemsContainer.appendChild(table);
        document.getElementById('cartSummary').style.display = 'block';
        document.getElementById('btnBayar').disabled = false;
    }
    calculateTotal(); // This will use activeQ.cart

    // Persist customerId and paymentMethod for the active queue
    activeQ.customerId = document.getElementById('pelangganSelect').value;
    activeQ.paymentMethod = document.getElementById('metodePembayaran').value;
    // Jangan kirim update ke backend di sini; updateQueueCartToBackend dipanggil hanya pada fungsi yang benar-benar memodifikasi cart/queue.
}

function incrementQuantity(itemId) {
    if (!activeQueueId) return;
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ) return;
    const item = activeQ.cart.find(i => i.id === itemId);

    if (item) {
        if (item.jumlah < item.stok_awal) {
            item.jumlah++; 
            
            // Periksa apakah harus menggunakan harga grosir
            if (item.harga_grosir && item.jumlah >= item.batas_minimal_grosir) {
                if (!item.harga_eceran) { item.harga_eceran = item.harga; }
                item.harga = item.harga_grosir;
                item.tipe_harga = 'grosir';
            }
            
            updateCartDisplay(); 
            highlightCartRow(itemId);
            updateQueueCartToBackend(activeQueueId);
        } else {
            alert(`Stok ${item.nama} tidak mencukupi (tersedia: ${item.stok_awal}).`);
        }
    }
}

function decrementQuantity(itemId) {
    if (!activeQueueId) return;
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ) return;
    const item = activeQ.cart.find(i => i.id === itemId);

    if (item && item.jumlah > 1) { 
        item.jumlah--; 
        
        // Periksa apakah harus kembali ke harga eceran
        if (item.harga_grosir && item.jumlah < item.batas_minimal_grosir && item.tipe_harga === 'grosir') {
            const hargaEceran = parseFloat(item.harga_eceran) || 0;
            if (hargaEceran > 0) {
                item.harga = hargaEceran;
                item.tipe_harga = 'eceran';
            }
        }
        
        updateCartDisplay(); 
        highlightCartRow(itemId);
        updateQueueCartToBackend(activeQueueId);
    }
    else if (item && item.jumlah === 1) { removeFromCart(itemId); } 
}

function updateQuantity(itemId, newQuantityStr) {
    if (!activeQueueId) return;
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ) return;
    const item = activeQ.cart.find(i => i.id === itemId);
    const quantity = parseFloat(newQuantityStr);

    console.log('Modern: updateQuantity called - itemId:', itemId, 'newQuantity:', newQuantityStr, 'parsed:', quantity);
    console.log('Modern: Current item before update:', JSON.stringify(item, null, 2));

    if (item && !isNaN(quantity)) {
        if (quantity <= 0) {
            removeFromCart(itemId); 
        } else if (quantity <= item.stok_awal) {
            const oldQuantity = item.jumlah;
            const oldPrice = item.harga;
            const oldPriceType = item.tipe_harga;
            
            item.jumlah = quantity;
            
            // Periksa apakah harus menggunakan harga grosir atau eceran
            if (item.harga_grosir) {
                if (quantity >= item.batas_minimal_grosir) {
                    if (!item.harga_eceran) { item.harga_eceran = item.harga; }
                    item.harga = item.harga_grosir;
                    item.tipe_harga = 'grosir';
                } else if (item.tipe_harga === 'grosir') {
                    // Kembali ke harga eceran jika sebelumnya grosir
                    const hargaEceran = parseFloat(item.harga_eceran) || 0;
                    if (hargaEceran > 0) {
                        item.harga = hargaEceran;
                        item.tipe_harga = 'eceran';
                    }
                }
            }
            
            console.log('Modern: Quantity updated from', oldQuantity, 'to', item.jumlah);
            console.log('Modern: Price changed from', oldPrice, '(' + oldPriceType + ') to', item.harga, '(' + item.tipe_harga + ')');
            console.log('Modern: Updated item:', JSON.stringify(item, null, 2));
            
            updateCartDisplay();
            updateQueueCartToBackend(activeQueueId);
        } else {
            item.jumlah = item.stok_awal;
            alert(`Stok ${item.nama} hanya ${item.stok_awal}. Jumlah disesuaikan.`);
            console.log('Modern: Quantity adjusted to stock limit:', item.stok_awal);
            updateCartDisplay();
            updateQueueCartToBackend(activeQueueId);
        }
    } else if (item) { 
        // Reset input field to current quantity if invalid input
        const inputField = document.querySelector(`input[onchange*="updateQuantity(${itemId}"]`);
        if (inputField) {
            inputField.value = item.jumlah;
        }
        console.log('Modern: Invalid quantity input, reset to:', item.jumlah);
        updateCartDisplay(); 
    }
}

function removeFromCart(itemId) {
    if (!activeQueueId) return;
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ) return;
    
    const item = activeQ.cart.find(i => i.id === itemId);
    if (!item) return;
    if (!confirm(`Hapus ${item.nama} dari keranjang?`)) { return; }
    
    activeQ.cart = activeQ.cart.filter(i => i.id !== itemId);
    updateCartDisplay(); 
    highlightCartRow(itemId);
    updateQueueCartToBackend(activeQueueId);
}

function calculateTotal() { // Calculates based on the active queue's cart
    let totalItems = 0, totalHarga = 0;
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (activeQ && activeQ.cart) {
        activeQ.cart.forEach(item => { 
            const itemJumlah = parseFloat(item.jumlah) || 0;
            const itemHarga = parseFloat(item.harga) || 0;
            totalItems += itemJumlah; 
            totalHarga += itemHarga * itemJumlah; 
        });
    }
    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('totalHarga').textContent = 'Rp ' + totalHarga.toLocaleString();
    
    // Update ringkasan harga di panel Informasi Transaksi (kanan)
    const transItemsEl = document.getElementById('transTotalItems');
    if (transItemsEl) transItemsEl.textContent = totalItems;
    const transHargaEl = document.getElementById('transTotalHarga');
    if (transHargaEl) transHargaEl.textContent = 'Rp ' + totalHarga.toLocaleString();
    return { totalItems, totalHarga };
}


function toggleCashPaymentFields() {
    const metodePembayaran = document.getElementById('metodePembayaran').value;
    const cashFields = document.getElementById('cashPaymentFields'); // In confirmation modal
    const paymentErrorDiv = document.getElementById('paymentError');
    
    if (metodePembayaran === 'tunai' && cashFields) { // Check if cashFields exists
        cashFields.style.display = 'block';
    } else if (cashFields) {
        cashFields.style.display = 'none';
        document.getElementById('jumlahBayarInput').value = '';
        document.getElementById('kembalianDisplay').value = 'Rp 0';
        if (paymentErrorDiv) paymentErrorDiv.style.display = 'none';
    }
    // Also update active queue's payment method if switching on main page
     const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (activeQ) {
        activeQ.paymentMethod = metodePembayaran;
        updateQueueCartToBackend(activeQueueId);
    }
}

function calculateChange() {
    const totalHargaStr = document.getElementById('konfirmasiTotalHarga').textContent.replace(/[^\d]/g, '');
    const totalHarga = parseInt(totalHargaStr, 10) || 0;
    let jumlahBayarRaw = document.getElementById('jumlahBayarInput').value.replace(/[^\d]/g, '');
    const jumlahBayar = parseInt(jumlahBayarRaw, 10) || 0;
    const kembalianDisplay = document.getElementById('kembalianDisplay');
    const paymentErrorDiv = document.getElementById('paymentError');
    const btnKonfirmasiFinal = document.getElementById('btnKonfirmasiFinal');

    if (jumlahBayar < totalHarga) {
        kembalianDisplay.value = 'Rp 0';
        if (paymentErrorDiv) {
            paymentErrorDiv.textContent = 'Jumlah bayar kurang dari total transaksi.';
            paymentErrorDiv.style.display = 'block';
        }
        btnKonfirmasiFinal.disabled = true;
    } else {
        const kembalian = jumlahBayar - totalHarga;
        kembalianDisplay.value = 'Rp ' + kembalian.toLocaleString('id-ID');
        if (paymentErrorDiv) paymentErrorDiv.style.display = 'none';
        btnKonfirmasiFinal.disabled = false;
    }
}


function prosesPembayaranCurrentQueue() {
    if (!activeQueueId) { alert("Tidak ada antrean aktif."); return; }
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ || activeQ.cart.length === 0) { alert("Antrean aktif kosong atau tidak valid."); return; }

    const { totalHarga } = calculateTotal(); // Calculates from activeQ.cart
    const pelangganSelect = document.getElementById('pelangganSelect');
    const selectedPelangganText = pelangganSelect.value ? pelangganSelect.options[pelangganSelect.selectedIndex].text : 'Umum';
    const metodePembayaran = document.getElementById('metodePembayaran').value; // Get from main page select

    document.getElementById('konfirmasiAntreanNama').textContent = activeQ.name;
    document.getElementById('konfirmasiTotalHarga').textContent = 'Rp ' + totalHarga.toLocaleString();
    document.getElementById('konfirmasiPelanggan').textContent = selectedPelangganText;
    document.getElementById('konfirmasiMetodeText').textContent = metodePembayaran.charAt(0).toUpperCase() + metodePembayaran.slice(1);
    
    // Call toggle for the modal based on the *main page's* selected method
    const cashFieldsModal = document.getElementById('cashPaymentFields');
    const jumlahBayarInputModal = document.getElementById('jumlahBayarInput');
    const kembalianDisplayModal = document.getElementById('kembalianDisplay');
    const paymentErrorDivModal = document.getElementById('paymentError');
    const btnKonfirmasiFinal = document.getElementById('btnKonfirmasiFinal');


    if (metodePembayaran === 'tunai') {
        cashFieldsModal.style.display = 'block';
    } else {
        cashFieldsModal.style.display = 'none';
        btnKonfirmasiFinal.disabled = false;
    }
    
    modalKonfirmasiInstance.show();
}


function konfirmasiDanBayarCurrentQueue() {
    if (!activeQueueId) { alert("Tidak ada antrean aktif untuk dibayar."); return; }
    
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ) { alert("Antrean aktif tidak ditemukan."); return; }

    const { totalHarga } = calculateTotal(); 
    const pelangganId = document.getElementById('pelangganSelect').value; // From main page
    const metodePembayaran = document.getElementById('metodePembayaran').value; // From main page
    
    let jumlahBayarTunai = null;
    if (metodePembayaran === 'tunai') {
        let raw = document.getElementById('jumlahBayarInput').value.replace(/[^\d]/g, '');
        jumlahBayarTunai = parseInt(raw, 10) || 0;
    }
    
    // Prepare payment data for backend
    const paymentData = {
        queue_id: activeQ.backendId, // integer DB id
        items: activeQ.cart.map(item => ({
            barang_id: item.id, // required by backend
            jumlah: parseFloat(item.jumlah) || 0,
            harga_satuan: parseFloat(item.harga) || 0,
            subtotal: (parseFloat(item.harga) || 0) * (parseFloat(item.jumlah) || 0),
            tipe_harga: item.tipe_harga || 'eceran',
        })),
        total_harga: totalHarga,
        pelanggan_id: pelangganId || null,
        metode_pembayaran: metodePembayaran,
        jumlah_bayar_tunai: jumlahBayarTunai
    };

    // Call backend to process payment
    modalKonfirmasiInstance.hide();
    
    fetch('/sales/proses_penjualan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Simpan data pembayaran terakhir untuk print
            window._lastPaymentData = {
                id: data.penjualan_id,
                no_transaksi: data.no_transaksi,
                queueName: activeQ.name,
                totalHarga: totalHarga,
                jumlahBayar: jumlahBayarTunai,
                kembalian: data.kembalian_tunai || (jumlahBayarTunai !== null ? (jumlahBayarTunai - totalHarga) : 0),
                pelanggan: pelangganId,
                metodePembayaran: metodePembayaran,
                waktu: new Date().toLocaleString('id-ID')
            };

            // Show success modal
            document.getElementById('printJumlahBayar').textContent = 'Rp ' + (jumlahBayarTunai||0).toLocaleString('id-ID');
            document.getElementById('printKembalian').textContent = 'Rp ' + (window._lastPaymentData.kembalian||0).toLocaleString('id-ID');
            const printStrukModal = new bootstrap.Modal(document.getElementById('modalPrintStruk'));
            printStrukModal.show();

            // Autofocus Print Struk button after modal animation using shown.bs.modal event
            const modalEl = document.getElementById('modalPrintStruk');
            function focusPrintBtnAfterShow() {
                const btnPrint = document.getElementById('btnPrintStruk');
                if (btnPrint) btnPrint.focus();
                modalEl.removeEventListener('shown.bs.modal', focusPrintBtnAfterShow);
            }
            modalEl.addEventListener('shown.bs.modal', focusPrintBtnAfterShow);

            const btnPrint = document.getElementById('btnPrintStruk');
            const btnClose = document.getElementById('btnClosePrintStruk');
            if (btnClose) {
                btnClose.addEventListener('click', function() {
                    // Hapus antrean di backend saat 'Tutup' diklik
                    if (activeQ && activeQ.backendId) {
                        fetch(`/sales/antrian/${activeQ.backendId}/hapus`, { method: 'POST' })
                        .then(() => {
                            // Remove completed queue from salesQueues and update UI
                            const idx = salesQueues.findIndex(q => q.id === activeQueueId);
                            if (idx !== -1) {
                                salesQueues.splice(idx, 1);
                                if (salesQueues.length > 0) {
                                    activeQueueId = salesQueues[0].id;
                                } else {
                                    activeQueueId = null;
                                }
                                renderQueueTabs();
                                updateCartDisplay();
                            }
                            printStrukModal.hide();
                        });
                    } else {
                        printStrukModal.hide();
                    }
                });
                // Keyboard arrow navigation
                btnClose.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        e.preventDefault();
                        if (btnPrint) btnPrint.focus();
                    }
                });
            }
            // ENTER key triggers focused button in modalPrintStruk
            const modalPrintStrukEl = document.getElementById('modalPrintStruk');
            modalPrintStrukEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const active = document.activeElement;
                    if (modalPrintStrukEl.contains(active) && active.tagName === 'BUTTON' && !active.disabled) {
                        e.preventDefault();
                        active.click();
                    }
                }
            });
            // Jika user refresh/tab close sebelum klik Tutup, auto-hapus antrean di backend
            let queueDeleted = false;
            function autoDeleteQueueOnUnload(e) {
                if (!queueDeleted && activeQ && activeQ.backendId) {
                    navigator.sendBeacon(`/sales/antrian/${activeQ.backendId}/hapus`);
                    queueDeleted = true;
                }
            }
            window.addEventListener('beforeunload', autoDeleteQueueOnUnload);
            if (btnClose) {
                btnClose.addEventListener('click', function() {
                    queueDeleted = true;
                    window.removeEventListener('beforeunload', autoDeleteQueueOnUnload);
                });
            }
            if (btnPrint) {
                btnPrint.addEventListener('click', function() {
                    // Redirect to struk.html with transaction id
                    let trxId = (window._lastPaymentData && window._lastPaymentData.id) ? window._lastPaymentData.id : '';
                    if (!trxId && typeof activeQueueId !== 'undefined') trxId = activeQueueId;
                    window.location.href = '/sales/struk/' + encodeURIComponent(trxId);
                });
                // Keyboard arrow navigation
                btnPrint.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        e.preventDefault();
                        if (btnClose) btnClose.focus();
                    }
                    // Fallback: Enter/Space triggers click
                    if ((e.key === 'Enter' || e.key === ' ') && document.activeElement === btnPrint) {
                        e.preventDefault();
                        btnPrint.click();
                    }
                });
            }
        } else {
            // Payment failed
            alert('Pembayaran gagal: ' + (data.message || 'Terjadi kesalahan'));
        }
    })
    .catch(error => {
        console.error('Error processing payment:', error);
        alert('Terjadi kesalahan saat memproses pembayaran. Silakan coba lagi.');
    });
}


// Render area struk untuk print
function renderStrukArea(data) {
    if (!data) return;
    let html = `<div style="max-width:350px;margin:0 auto;padding:18px 8px;font-family:monospace;font-size:15px;">
        <div style="text-align:center;">
            <b>POSEIDON MART</b><br/>
            <small>${data.waktu||''}</small>
        </div>
        <hr/>
        <div>Antrean: <b>${data.queueName||''}</b></div>
        <div>Total: <b>Rp ${(data.totalHarga||0).toLocaleString('id-ID')}</b></div>
        <div>Bayar: <b>Rp ${(data.jumlahBayar||0).toLocaleString('id-ID')}</b></div>
        <div>Kembali: <b>Rp ${(data.kembalian||0).toLocaleString('id-ID')}</b></div>
        <div>Pelanggan: <b>${data.pelanggan||'Umum'}</b></div>
        <div>Metode: <b>${data.metodePembayaran||'-'}</b></div>
        <hr/>
        <div style="text-align:center;">Terima kasih!</div>
    </div>`;
    document.getElementById('strukArea').innerHTML = html;
    document.getElementById('strukArea').classList.remove('d-none');
    setTimeout(()=>{
        document.getElementById('strukArea').classList.add('d-none');
    }, 500);
        if (jumlahBayarTunai < totalHarga) {
            alert("Jumlah bayar kurang dari total harga.");
            document.getElementById('jumlahBayarInput').focus();
            return; // Don't proceed
        }
    
    
    modalKonfirmasiInstance.hide(); // Hide modal before fetch

    const saleData = {
        pelanggan_id: pelangganId || null, 
        total_harga: totalHarga,
        metode_pembayaran: metodePembayaran,
        jumlah_bayar_tunai: metodePembayaran === 'tunai' ? jumlahBayarTunai : null,
        items: activeQ.cart.map(item => ({ 
            barang_id: item.id, 
            jumlah: parseFloat(item.jumlah) || 0, 
            harga_satuan: parseFloat(item.harga) || 0, 
            subtotal: (parseFloat(item.harga) || 0) * (parseFloat(item.jumlah) || 0),
            tipe_harga: item.tipe_harga || 'eceran'
        }))
    };

    const btnBayarEl = document.getElementById('btnBayar'); // Main page button
    btnBayarEl.disabled = true;
    btnBayarEl.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memproses...';

    fetch('/sales/proses_penjualan', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, 
        body: JSON.stringify(saleData) 
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errData => {
                throw new Error(errData.message || `Server error: ${response.status}`);
            }).catch(() => {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            let successMessage = `Transaksi ${data.no_transaksi} untuk ${activeQ.name} berhasil!`;
            if (data.kembalian_tunai !== null && data.kembalian_tunai !== undefined) {
                successMessage += `\nKembalian: Rp ${parseFloat(data.kembalian_tunai).toLocaleString()}`;
            }
            alert(successMessage);

            const finishedQueueId = activeQueueId; 
            
            // Hapus dari backend terlebih dahulu agar tidak tersisa di DB
            if (finishedQueueId) {
                const backendId = String(finishedQueueId).replace(/^antrian-/, ''); // remove prefix if any
                if (backendId && !isNaN(backendId)) {
                    fetch(`/sales/antrian/${backendId}/hapus`, {method:'POST', keepalive: true}).catch(console.error);
                }
            }

            salesQueues = salesQueues.filter(q => q.id !== finishedQueueId);
            
            if (salesQueues.length > 0) {
                activeQueueId = salesQueues[0].id; 
                switchQueue(activeQueueId); // This will also save and render
            } else {
                activeQueueId = null; 
                addQueue(); // This will create a new queue and make it active
            }
            //window.open(`/sales/struk/${data.penjualan_id}?auto_print=1`, '_blank');
            location.href = `/sales/struk/${data.penjualan_id}?auto_print=1`;
        } else { 
            alert(`Gagal memproses transaksi untuk ${activeQ.name}: ${data.message}`); 
        }
    })
    .catch(error => { 
        console.error('Error during payment processing:', error); 
        alert(`Terjadi kesalahan saat memproses pembayaran: ${error.message}. Silakan cek konsol untuk detail.`); 
    })
    .finally(() => {
        const currentActiveQAfterPayment = salesQueues.find(q => q.id === activeQueueId);
        btnBayarEl.disabled = (!currentActiveQAfterPayment || currentActiveQAfterPayment.cart.length === 0);
        btnBayarEl.innerHTML = '<i class="fas fa-credit-card me-2"></i>Proses Pembayaran (F2)';
    });
}

function resetCurrentQueueConfirm() {
    if (!activeQueueId) { alert("Tidak ada antrean aktif untuk direset."); return; }
    const activeQ = salesQueues.find(q => q.id === activeQueueId);
    if (!activeQ) { alert("Antrean aktif tidak valid."); return;}

    if (confirm("Anda yakin ingin mereset antrean ini? Semua item di keranjang antrean ini akan dihapus.")) {
        activeQ.cart = []; 
        // Optionally reset customer and payment method for the queue object
        // activeQ.customerId = '';
        // activeQ.paymentMethod = 'tunai'; 
        // document.getElementById('pelangganSelect').value = activeQ.customerId;
        // document.getElementById('metodePembayaran').value = activeQ.paymentMethod;
        updateCartDisplay(); 
        updateQueueCartToBackend(activeQueueId);
    }
}

// Toast notification functions
function showToast(title, message, type = 'success') {
    const toast = document.getElementById('liveToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    
    // Set toast content
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    
    // Set toast type/color
    toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white');
    if (type === 'success') {
        toast.classList.add('bg-success', 'text-white');
    } else if (type === 'error') {
        toast.classList.add('bg-danger', 'text-white');
    } else if (type === 'warning') {
        toast.classList.add('bg-warning');
    } else if (type === 'info') {
        toast.classList.add('bg-info');
    }
    
    // Show the toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Global variables for search navigation
let selectedSearchIndex = -1;
let searchResultItems = [];

// Keyboard shortcuts
function handleShortcut(e) {
    // F7: Pindah ke antrean sebelumnya
    if (e.key === 'F7') {
        e.preventDefault();
        goToPreviousQueue();
        return;
    }
    // F8: Pindah ke antrean selanjutnya
    if (e.key === 'F8') {
        e.preventDefault();
        goToNextQueue();
        return;
    }
    // Handle search results navigation when search input is focused
    if (document.activeElement.id === 'searchBarang') {
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateSearchResults('down');
            return;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateSearchResults('up');
            return;
        } else if (e.key === 'Enter') {
            e.preventDefault();
            selectCurrentSearchResult();
            return;
        } else if (e.key === 'Escape') {
            e.preventDefault();
            clearSearchResults();
            return;
        }
    }
    
    // Hindari jika dalam form element atau dialog terbuka (kecuali search input untuk navigasi)
    if ((document.activeElement.tagName === 'INPUT' && document.activeElement.id !== 'searchBarang') || 
        document.activeElement.tagName === 'TEXTAREA' || 
        document.activeElement.tagName === 'SELECT' ||
        document.querySelector('.modal.show')) {
        return;
    }
    
    if (e.key === 'F1') {
        e.preventDefault();
        document.getElementById('searchBarang').focus();
    } else if (e.key === 'F2') {
        e.preventDefault();
        if (!document.getElementById('btnBayar').disabled) {
            prosesPembayaranCurrentQueue();
        }
    } else if (e.key === 'F3') {
        e.preventDefault();
        resetCurrentQueueConfirm();
    } else if (e.key === 'F4') {
        e.preventDefault();
        addQueue();
    }
}

// Search results navigation functions
function navigateSearchResults(direction) {
    const searchResultsDiv = document.getElementById('searchResults');
    searchResultItems = searchResultsDiv.querySelectorAll('.list-group-item:not(.disabled)');
    
    if (searchResultItems.length === 0) return;
    
    // Remove previous selection
    searchResultItems.forEach(item => item.classList.remove('active'));
    
    if (direction === 'down') {
        selectedSearchIndex = (selectedSearchIndex + 1) % searchResultItems.length;
    } else if (direction === 'up') {
        selectedSearchIndex = selectedSearchIndex <= 0 ? searchResultItems.length - 1 : selectedSearchIndex - 1;
    }
    
    // Add selection to current item
    if (selectedSearchIndex >= 0 && selectedSearchIndex < searchResultItems.length) {
        searchResultItems[selectedSearchIndex].classList.add('active');
        searchResultItems[selectedSearchIndex].scrollIntoView({ block: 'nearest' });
    }
}

function selectCurrentSearchResult() {
    if (selectedSearchIndex >= 0 && selectedSearchIndex < searchResultItems.length) {
        searchResultItems[selectedSearchIndex].click();
        clearSearchResults();
    }
}

function clearSearchResults() {
    selectedSearchIndex = -1;
    searchResultItems = [];
    const searchResultsDiv = document.getElementById('searchResults');
    searchResultsDiv.innerHTML = '';
    searchResultsDiv.classList.add('d-none');
    document.getElementById('searchBarang').value = '';
}

// Reset search navigation when new results are loaded
function resetSearchNavigation() {
    selectedSearchIndex = -1;
    searchResultItems = [];
}

// Function to search for products by exact barcode
function searchBarangByExactBarcode(barcode, hideAfterResults) {
    if (!activeQueueId) return;
    const searchResultsDiv = document.getElementById('searchResults');
    
    fetch(`/sales/api/cari_barang?q=${encodeURIComponent(barcode)}&limit=1`)
    .then(response => response.json())
    .then(data => {
        if (data.length > 0) {
            const lowerBarcode = (barcode || '').toLowerCase();
            const exactMatch = data.find(item => (item.kode_barang || '').toLowerCase() === lowerBarcode);
            if (exactMatch) {
                // Found exact match by barcode - add directly to cart
                const barang = exactMatch;
                addToCart(
                    barang.id, 
                    barang.nama_barang, 
                    barang.kode_barang, 
                    barang.harga_jual, 
                    barang.stok, 
                    barang.satuan || 'Pcs',
                    barang.harga_grosir,
                    barang.batas_minimal_grosir || 10
                );
                showToast('Sukses', `Barang "${barang.nama_barang}" berhasil ditambahkan ke keranjang`, 'success');
                // Hide search results temporarily if requested
                if (hideAfterResults) {
                    searchResultsDiv.innerHTML = '';
                    searchResultsDiv.classList.add('d-none');
                }
            } else {
                // Show search results
                searchResultsDiv.classList.remove('d-none');
                searchBarangApiCall();
            }
        } else {
            searchResultsDiv.classList.remove('d-none');
            // No results found
            searchResultsDiv.innerHTML = '<div class="list-group-item text-muted">Barang tidak ditemukan.</div>';
            showToast('Peringatan', 'Barang Tidak Ditemukan', 'error');
        }
    })
    .catch(error => { console.error("Error searching for barcode:", error); searchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Terjadi kesalahan saat mencari barang.</div>';});
}

document.getElementById('addQueueBtn').addEventListener('click', addQueue);
document.getElementById('metodePembayaran').addEventListener('change', toggleCashPaymentFields);


document.addEventListener('DOMContentLoaded', async function() { 
    // Check for saved view mode and set toggle accordingly
    const savedViewMode = getCookie('sales_view_mode') || 'modern';
    const classicRadio = document.getElementById('classicMode');
    const modernRadio = document.getElementById('modernMode');
    if (savedViewMode === 'classic' && classicRadio) {
        classicRadio.checked = true;
        modernRadio.checked = false;
    } else if (modernRadio) {
        modernRadio.checked = true;
        if (classicRadio) classicRadio.checked = false;
    }
    
    // Try to restore state from transition first
    restoreStateAfterTransition();
    
    // If no restored state, load from backend
    if (salesQueues.length === 0) {
        await syncQueuesFromBackend(); // Load antrean kasir dari backend saat page load
        if (salesQueues.length > 0) {
            activeQueueId = salesQueues[0].id;
            await switchQueue(activeQueueId);
        } else {
            activeQueueId = null;
            renderQueueTabs();
            updateCartDisplay();
        }
    }
    loadQuickAddItems();
    toggleCashPaymentFields(); // Initial call for the main page select
    
    // Focus on search input after initial load
    setTimeout(() => {
        const searchInput = document.getElementById('searchBarang');
        if (searchInput) searchInput.focus();
    }, 200);
    
    // Initialize toast
    document.querySelectorAll('.toast').forEach(toastEl => {
        new bootstrap.Toast(toastEl, {
            delay: 3000
        });
    });
    
    // Register keyboard shortcuts with proper cleanup and re-registration
    function registerKeyboardShortcuts() {
        // Remove existing listener to prevent duplicates
        document.removeEventListener('keydown', handleShortcut);
        // Add the listener
        document.addEventListener('keydown', handleShortcut);
    }
    
    // Initial registration
    registerKeyboardShortcuts();
    
    // Re-register shortcuts when window regains focus to ensure they always work
    window.addEventListener('focus', function() {
        setTimeout(registerKeyboardShortcuts, 100);
    });
    
    // Also re-register when clicking anywhere on the document
    document.addEventListener('click', function() {
        registerKeyboardShortcuts();
    });
    
    // Barcode scanning detection
    document.addEventListener('keypress', function(e) {
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') return; 
        if (!activeQueueId) return; 
        clearTimeout(barcodeEventTimeout);
        if (e.key === 'Enter') {
            if (barcodeBuffer.length > 3) { 
                document.getElementById('searchBarang').value = barcodeBuffer; 
                searchBarangByExactBarcode(barcodeBuffer, true); // Use exact barcode search
            }
            barcodeBuffer = ''; 
            e.preventDefault(); 
        } else { 
            barcodeBuffer += e.key; 
        }
        barcodeEventTimeout = setTimeout(() => { barcodeBuffer = ''; }, 250);
    });

    
    // Enhanced Enter key handling in search field
    // Enhanced barcode scanner support
let searchTimeout;
let lastSearchQuery = '';

document.getElementById('searchBarang').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const query = this.value.trim();
        // Jika input kemungkinan barcode (angka/huruf, panjang > 3), langsung pakai searchBarangByExactBarcode
        if (/^[A-Za-z0-9]{4,}$/.test(query)) {
            searchBarangByExactBarcode(query, true);
            return;
        }
        // Jika bukan barcode, tetap lakukan pencarian dan auto-add jika hasil satu
        if (query !== lastSearchQuery && query.length > 0) {
            searchBarangApiCall(query);
            lastSearchQuery = query;
        }
        setTimeout(() => {
            const searchResultsDiv = document.getElementById('searchResults');
            const items = Array.from(searchResultsDiv.querySelectorAll('.list-group-item:not(.disabled)'));
            if (items.length === 1) {
                const btn = items[0].querySelector('button[data-add]');
                if (btn) btn.click();
                else items[0].click();
                clearSearchResults();
                return;
            }
            let found = false;
            for (const item of items) {
                const kode = item.getAttribute('data-kode') || '';
                if (kode.toLowerCase() === query.toLowerCase()) {
                    const btn = item.querySelector('button[data-add]');
                    if (btn) btn.click();
                    else item.click();
                    clearSearchResults();
                    found = true;
                    break;
                }
            }
            if (!found && /^[A-Za-z0-9]+$/.test(query)) {
                searchBarangApiCall(query);
            }
        }, 100);
    }
});

// Debounced search for better barcode scanner support
document.getElementById('searchBarang').addEventListener('input', function() {
    const query = this.value.trim();
    lastSearchQuery = query;
    
    clearTimeout(searchTimeout);
    if (query.length > 0) {
        searchTimeout = setTimeout(() => {
            searchBarangApiCall(query);
        }, 150); // Reduced delay for faster barcode scanning
    } else {
        clearSearchResults();
    }
});

    document.getElementById('searchBarang').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { searchBarangApiCall(); }, 300);
    });
});

function searchBarangManual() { searchBarangApiCall(); }

function searchBarangApiCall() {
    if (!activeQueueId) return;
    const searchInputEl = document.getElementById('searchBarang');
    const query = (searchInputEl.value || '').trim();
    const searchResultsDiv = document.getElementById('searchResults');
    if (query.length === 0) {
        searchResultsDiv.innerHTML = '';
        searchResultsDiv.classList.add('d-none');
        return; // Jangan lakukan fetch jika kosong
    }
    // Jika ada input, pastikan div hasil terlihat
    searchResultsDiv.classList.remove('d-none');
    fetch(`/sales/api/cari_barang?q=${encodeURIComponent(query)}&limit=5`)
    .then(response => response.json())
    .then(data => {
        let html = '';
        if (data.length > 0) {
            data.forEach(barang => {
                const hargaJual = parseFloat(barang.harga_jual) || 0;
                const hargaGrosir = parseFloat(barang.harga_grosir) || 0;
                const stok = parseFloat(barang.stok) || 0;
                const satuan = barang.satuan || 'Pcs';
                const batasMinimalGrosir = parseFloat(barang.batas_minimal_grosir) || 10;

                let expiryWarning = '';
                 if (barang.tanggal_kadaluarsa) {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const expiryDate = new Date(barang.tanggal_kadaluarsa);
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) expiryWarning = `<span class="badge bg-danger ms-1" style="font-size: 0.7em;">Exp</span>`;
                    else if (diffDays <= 30) expiryWarning = `<span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">Exp ${diffDays}d</span>`;
                }
                
                // Tambahkan info harga grosir dan satuan
                let hargaDisplay = `Rp ${hargaJual.toLocaleString()}/${satuan}`;
                if (hargaGrosir > 0) {
                    hargaDisplay += ` | Grosir: Rp ${hargaGrosir.toLocaleString()} (min. ${batasMinimalGrosir})`;
                }
                
                html += `
                    <a href="#" class="list-group-item list-group-item-action ${stok <= 0 ? 'disabled text-muted' : ''}" 
                       onclick="event.preventDefault(); if(${stok > 0}) { addToCart(${barang.id}, '${barang.nama_barang.replace(/'/g, "\\'")}', '${barang.kode_barang}', ${hargaJual}, ${stok}, '${satuan}', ${hargaGrosir}, ${batasMinimalGrosir}); }">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${barang.nama_barang} (${barang.kode_barang}) ${expiryWarning}</h6>
                            <small class="text-success fw-bold">Rp ${hargaJual.toLocaleString()}</small>
                        </div>
                        <small>Stok: ${stok} ${satuan}</small>
                        ${hargaGrosir > 0 ? `<small class="d-block">Grosir: Rp ${hargaGrosir.toLocaleString()} (min. ${batasMinimalGrosir} ${satuan})</small>` : ''}
                        ${stok <= 0 ? '<span class="badge bg-secondary float-end">Habis</span>' : ''}
                    </a>`;
            });
        } else { 
            html = '<div class="list-group-item text-muted">Barang tidak ditemukan.</div>';
            showToast('Peringatan', 'Barang Tidak Ditemukan', 'error');
        }
        searchResultsDiv.innerHTML = html;
        resetSearchNavigation(); // Reset navigation state when new results are loaded
    })
    .catch(error => { 
        console.error("Error loading search results:", error); 
        searchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Terjadi kesalahan saat mencari barang.</div>';
        resetSearchNavigation();
    });
}

function loadQuickAddItems() {
    const quickAddDiv = document.getElementById('quickAddItems');
    fetch(`/sales/api/cari_barang?limit=4&sort=popular`) 
    .then(response => response.json())
    .then(data => {
        if (data.length > 0) {
            let html = '<ul class="list-group list-group-flush">';
            data.forEach(barang => {
                const hargaJual = parseFloat(barang.harga_jual) || 0;
                const hargaGrosir = parseFloat(barang.harga_grosir) || 0;
                const stok = parseFloat(barang.stok) || 0;
                const satuan = barang.satuan || 'Pcs';
                const batasMinimalGrosir = parseFloat(barang.batas_minimal_grosir) || 10;

                let expiryWarning = '';
                 if (barang.tanggal_kadaluarsa) {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const expiryDate = new Date(barang.tanggal_kadaluarsa);
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) expiryWarning = `<span class="badge bg-danger ms-1" style="font-size: 0.7em;">Exp</span>`;
                    else if (diffDays <= 30) expiryWarning = `<span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">Exp ${diffDays}d</span>`;
                }
                
                // Tambahkan info harga grosir dan satuan
                let hargaDisplay = `Rp ${hargaJual.toLocaleString()}/${satuan}`;
                if (hargaGrosir > 0) {
                    hargaDisplay += ` | Grosir: Rp ${hargaGrosir.toLocaleString()} (min. ${batasMinimalGrosir})`;
                }
                
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1 ${stok <= 0 ? 'text-muted' : ''}" style="cursor:${stok > 0 ? 'pointer': 'default'};" 
                             onclick="if(${stok > 0}) { addToCart(${barang.id}, '${barang.nama_barang.replace(/'/g, "\\'")}', '${barang.kode_barang}', ${hargaJual}, ${stok}, '${satuan}', ${hargaGrosir}, ${batasMinimalGrosir}); }">
                            ${barang.nama_barang} ${expiryWarning}
                            <small class="d-block">${hargaDisplay}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-success ms-2" 
                                onclick="addToCart(${barang.id}, '${barang.nama_barang.replace(/'/g, "\\'")}', '${barang.kode_barang}', ${hargaJual}, ${stok}, '${satuan}', ${hargaGrosir}, ${batasMinimalGrosir})"
                                ${stok <= 0 ? 'disabled' : ''} title="Tambah ke Keranjang">
                            <i class="fas fa-plus"></i>
                        </button>
                    </li>`;
            });
            html += '</ul>'; quickAddDiv.innerHTML = html;
        } else { quickAddDiv.innerHTML = '<p class="text-muted p-3"><small>Tidak ada barang.</small></p>'; }
    })
    .catch(error => { console.error("Error loading quick add items:", error); quickAddDiv.innerHTML = '<p class="text-danger p-3"><small>Gagal memuat.</small></p>';});
}
// Format input jumlahBayarInput menjadi format ribuan saat mengetik
function formatRupiahInput(input) {
    let raw = input.value.replace(/[^\d]/g, ''); // hanya angka
    if (raw === '') {
        input.value = '';
        return;
    }
    // Simpan posisi caret relatif ke akhir
    let caret = input.selectionStart;
    let prevLength = input.value.length;
    // Format angka
    let formatted = parseInt(raw, 10).toLocaleString('id-ID');
    input.value = 'Rp ' + formatted;
    // Hitung selisih panjang
    let newLength = input.value.length;
    caret += newLength - prevLength;
    // Pastikan caret tidak sebelum "Rp "
    if (caret < 4) caret = newLength;
    input.setSelectionRange(caret, caret);
}

// Highlight cart row and tbody effect
function highlightCartRow(itemId) {
    setTimeout(() => {
        console.log("HIGHTLIGHTED");
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        if (!cartItemsContainer) return;
        const row = cartItemsContainer.querySelector(`tr[data-item-id='${itemId}']`);
        if (row) {
            console.log(row);
            // Highlight only the row with direct background-color
            const prevColor = row.style.backgroundColor;
            row.style.backgroundColor = '#fff7b2'; // soft yellow
            setTimeout(() => {
                row.style.backgroundColor = prevColor || '';
            }, 750);
        }
    }, 50);
}
</script>
{% endblock %}